/**
 * Newsgroup reader
 * @module     mod/newsmod/Reader
 * @class      newsmod
 * @copyright  2020 Niels Seidel <niels.seidel@fernuni-hagen.de>
 * @license    MIT
 * @since      3.1
 */
define(["jquery",M.cfg.wwwroot+"/mod/newsmod/lib/build/vue.min.js",M.cfg.wwwroot+"/mod/newsmod/lib/build/axios.min.js",M.cfg.wwwroot+"/mod/newsmod/lib/build/identicon.min.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/ReaderMessageBody.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/ReaderPostContainer.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/VizBubble.js"],(function(t,e,i,n,s,o,a){return function(r,d,c){var l=new e({el:"newsmod-container",data:function(){return{searchstring:"",searchresult:[],hiddenposts:[],filter_assessment:!0,filter_text:!0,content:[],tree_data:"",treedata_viz:{},sequence:1,arraypos:0,post_list:[],singlepostdata:[],msgbodycontainerdisplay:"none",isreading:!1,isanswering:!1,iscreatingtopic:!1,markedpost:-1,courseid:d,hideloadingicon:!0,hideloadingiconRMB:!0,identiconstring:"",viewportsize:"none",showmodal:!1,displayerrormsg:!1,newsgroup_name:"",newsgroup_postquantity:0}},components:{"messagebody-container":s,"post-container":o,"viz-bubble":a},created:function(){this.singlepostdata.header={name:"",subject:""},r.add("hello_world",{level:"fun",target:"vue is in place"}),t(".nav-link-h4").click((function(){r.add("toc_entry_open",{level:"h4",target:t(this).attr("href")})})),t(".nav-link-h3").click((function(){r.add("toc_entry_open",{level:"h3",target:t(this).attr("href")})})),window.addEventListener("resize",this.Windowresizehandler),Math.max(document.documentElement.clientWidth||0,window.innerWidth||0)<576?this.viewportsize="mobile":this.viewportsize="other"},destroyed(){window.removeEventListener("resize",this.Windowresizehandler)},mounted:function(){this.getgroupinfo(),this.hideloadingicon=!1,i.get(M.cfg.wwwroot+"/mod/newsmod/php/phpconn5.php?id="+d).then((function(t){l.check_for_error(t.data)?l.post_list.push(l.prepare_postdata(t.data)):(l.treedata_viz=t.data.children,l.info=t,l.tree_data=t.data,l.buildtree(t.data,1))})).catch((function(t){console.log(t)})).then((function(){l.hideloadingicon=!0}))},computed:{},methods:{Windowresizehandler:function(){Math.max(document.documentElement.clientWidth||0,window.innerWidth||0)<576?(this.viewportsize="mobile",""==this.msgbodycontainerdisplay&&(this.showmodal=!0)):(this.viewportsize="other",this.showmodal=!1)},getgroupinfo:function(){i.get(M.cfg.wwwroot+"/mod/newsmod/php/groupinfo.php?id="+d).then((function(t){l.check_for_error(t.data)?l.post_list.push(l.prepare_postdata(t.data)):l.processgroupinfo(t.data)})).catch((function(t){console.log(t)}))},processgroupinfo:function(t){l.newsgroup_name=t.groupname,l.newsgroup_postquantity=t.lastarticle-t.firstarticle+1},getMessageTree:function(){return this.tree_data.children},findinarr:function(t,e){for(let i=0;i<e.length;i++)if(e[i].messageid===t)return e[i]},ondisplaymsg:function(t){this.hideloadingiconRMB=!1,i.get(M.cfg.wwwroot+"/mod/newsmod/php/messageid.php?id="+d+"&msgnr="+t).then((function(t){l.check_for_error(t.data)?l.post_list.push(l.prepare_postdata(t.data)):(l.singlepostdata=t.data,l.identiconstring=l.getidenticon(l.singlepostdata.header.from+l.singlepostdata.header.name))})).catch((function(t){console.log(t)})).then((function(){l.hideloadingiconRMB=!0})),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1;let e=this.findinarr(t,this.post_list).arraypos;this.markedpost=e,"mobile"==this.viewportsize&&(this.showmodal=!0)},setSelected:function(t){this.markedpost=t},onprevmsg:function(t){this.hideloadingiconRMB=!1;let n=this.findinarr(t,this.post_list).arraypos;n-=1,this.markedpost=n,t=this.post_list[n].messageid;let s=this.findinarr(t,this.post_list);s.hidden=!1,e.set(this.post_list,n,s),console.log(n),console.log(t),i.get(M.cfg.wwwroot+"/mod/newsmod/php/messageid.php?id="+d+"&msgnr="+t).then((function(t){l.check_for_error(t.data)?l.post_list.push(l.prepare_postdata(t.data)):(l.singlepostdata=t.data,l.identiconstring=l.getidenticon(l.singlepostdata.header.from+l.singlepostdata.header.name))})).catch((function(t){console.log(t)})).then((function(){l.hideloadingiconRMB=!0})),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onnextmsg:function(t){this.hideloadingiconRMB=!1;let n=this.findinarr(t,this.post_list);console.log(n.arraypos);let s=n.arraypos;s+=1,this.markedpost=s,t=this.post_list[s].messageid;let o=this.findinarr(t,this.post_list);o.hidden=!1,e.set(this.post_list,s,o),console.log(s),console.log(t),i.get(M.cfg.wwwroot+"/mod/newsmod/php/messageid.php?id="+d+"&msgnr="+t).then((function(t){l.check_for_error(t.data)?l.post_list.push(l.prepare_postdata(t.data)):(l.singlepostdata=t.data,l.identiconstring=l.getidenticon(l.singlepostdata.header.from+l.singlepostdata.header.name))})).catch((function(t){console.log(t)})).then((function(){l.hideloadingiconRMB=!0})),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onansweredmsg:function(){this.hideloadingicon=!1,l.post_list.splice(0),this.arraypos=0,this.msgbodycontainerdisplay="none",this.isanswering=!1,this.iscreatingtopic=!1,this.isreading=!1,setTimeout((function(){i.get(M.cfg.wwwroot+"/mod/newsmod/php/phpconn5.php?id="+l.courseid).then((function(t){l.check_for_error(t.data)?l.post_list.push(l.prepare_postdata(t.data)):(l.info=t,l.tree_data=t.data,l.buildtree(t.data,1))})).catch((function(t){console.log(t)})).then((function(){l.hideloadingicon=!0}))}),2e3)},closemodal:function(){this.showmodal=!1,this.msgbodycontainerdisplay="none"},check_if_empty:function(t){if(!("user_id"in t.children[0])){var e={marked:!1,unread:!0,personal:"System message",sender:"noname@none.com",user_id:-99,margin:0,sequence:0,messageid:1,date:"01.01.2020",subject:"No postings",absender:"noname@none.com",arraypos:this.arraypos++,isSelected:!1,hidden:!1};this.post_list.push(e)}},prepare_postdata:function(t,e=1){var i,n="0"!=t.markedstatus,s="0"==t.messagestatus,o=!1;if(t.picturestatus>"0")i=M.cfg.wwwroot+"/user/pix.php/"+t.user_id+"/f1.jpg";else{var a={background:[255,255,255,255],margin:.05,size:20,format:"svg"};i=this.getidenticon(t.sender+t.personal)}if(o=!!t.children,!t.children);var r=new Date(t.date);a={year:"numeric",month:"2-digit",day:"2-digit"};r=new Date(t.date).toLocaleDateString("de-DE",a)?new Date(t.date).toLocaleDateString("de-DE",a):"";var d,c=t.personal?t.personal:t.sender;return t.children&&(d=this.getfamily(t)),{marked:n,unread:s,markedhtml:n,picturestatus:t.picturestatus,personal:t.personal,sender:t.sender,user_id:t.user_id,margin:e,sequence:this.sequence++,messageid:t.messageid,date:t.date,subject:t.name,calctime:r,absender:c,haschild:o,arraypos:this.arraypos++,isSelected:!1,hidden:!1,family:d,identicon:i}},buildtree:function(t,e){t.children.forEach(t=>{let i=this.prepare_postdata(t,e);this.post_list.push(i),t.children&&l.buildtree(t,e+15)})},getfamily:function(t){var e=[];if(t.children){var i=t.children.length;for(let n=0;n<i;n++)e.push(t.children[n].messageid),t.children[n].children&&e.push(l.getfamily(t.children[n]))}return e},newTopic:function(){this.msgbodycontainerdisplay="",this.iscreatingtopic=!0,this.isreading=!1,this.isanswering=!1},search:function(t){this.hideallposts(),this.hideloadingicon=!1,i.get(M.cfg.wwwroot+"/mod/newsmod/php/search.php?id="+d+"&searchparam="+this.searchstring).then((function(t){l.check_for_error(t.data)?(l.post_list.push(l.prepare_postdata(t.data)),l.displayerrormsg=!0):l.displaysearchresult("",t.data)})).catch(t=>console.log(t)).then((function(){l.hideloadingicon=!0}))},hideallposts:function(){for(let t=0;t<this.post_list.length;t++){let i=this.post_list[t];i.hidden=!0,e.set(this.post_list,t,i)}},showallposts:function(){for(let t=0;t<this.post_list.length;t++){let i=this.post_list[t];i.hidden=!1,e.set(this.post_list,t,i)}},displaysearchresult:function(t,i){this.hideallposts();for(let t=0;t<i.length;t++){this.hiddenposts.push(this.findinarr(i[t].messagenum,this.post_list));let n=this.hiddenposts[t];void 0!==n.hidden?(n.hidden=!1,e.set(this.post_list,n.arraypos,n)):console.log("err displaysearchresult")}},resetsearchstring:function(){this.searchstring="",this.hiddenposts.splice(0),this.displayerrormsg&&(this.post_list.pop(),this.arraypos--,this.displayerrormsg=!1),this.showallposts()},refresh:function(){this.hideloadingicon=!1,this.isreading=!1,this.isanswering=!1,this.msgbodycontainerdisplay="none",this.markedpost=-1,this.arraypos=0,this.post_list.splice(0),i.get(M.cfg.wwwroot+"/mod/newsmod/php/phpconn5.php?id="+d).then((function(t){l.check_for_error(t.data)?l.post_list.push(l.prepare_postdata(t.data)):(l.treedata_viz=t.data.children,l.info=t,l.tree_data=t.data,l.check_if_empty(t.data),l.buildtree(t.data,1))})).catch((function(t){console.log(t)})).then((function(){l.hideloadingicon=!0}))},getidenticon:function(t){var e=this.hash64(t,!0);return"data:image/svg+xml;base64,"+new n(e,{background:[255,255,255,255],margin:.05,size:20,format:"svg"}).toString()},hash32:function(t,e,i){var n,s,o=void 0===i?2166136261:i;for(n=0,s=t.length;n<s;n++)o^=t.charCodeAt(n),o+=(o<<1)+(o<<4)+(o<<7)+(o<<8)+(o<<24);return e?("0000000"+(o>>>0).toString(16)).substr(-8):o>>>0},hash64:function(t,e){var i=this.hash32(t,e);return i+this.hash32(i+t,e)},check_for_error:function(t){return void 0!==t.is_error}},template:'\n                <div id="newsmod-container">\n                    <ul class="nav nav-pills">\n                        <li class="nav-item">\n                            <a class="nav-link active" data-toggle="pill" href="#home">Liste</a>\n                        </li>\n                        <li class="nav-item">\n                            <a class="nav-link" data-toggle="pill" href="#menu1">Bubbles</a>\n                        </li>\n                    </ul>\n                    <div>\n                        <div class="form-inline">\n                            <button class="btn btn-outline-primary btn-sm" v-on:click="newTopic" title="Ein neues Thema erstellen">\n                                <i class="fa fa-pen"></i>\n                                Neues Thema\n                            </button>\n\n                            <button class="btn btn-light btn-sm" v-on:click="refresh" title="Neue Nachrichten abholen">\n                                    <i class="fa fa-sync"></i>\n                            </button>\n                            <div class="search">\n                                <input class="form-control form-control-sm" v-model="searchstring" placeholder="Suchen..." v-on:click="resetsearchstring">\n\n                                <button class="btn btn-light btn-sm" type="submit" v-on:click="search" title="In allen Nachrichten suchen">\n                                    Suchen\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                    <div class = "tab-content">\n                        <div class="container-fluid px-0 tab-pane active" id="home" style = "height:auto;">\n                            <div class="px-0">\n                                <hr />\n                                <div class="row" >\n                                    <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-12" id="tree" style="overflow:scroll; margin-bottom:3px; height: 500px;" >\n                                        <post-container \n                                            v-bind:courseid="courseid" \n                                            v-bind:postlist="post_list" \n                                            v-bind:markedpost="markedpost" \n                                            :showloadingicon="hideloadingicon"\n                                            :viewportsize = "viewportsize"\n                                            v-on:displaymsg="ondisplaymsg"\n                                            v-on:setSelected="setSelected">\n                                        </post-container>\n                                    </div>\n                                    <div :class="[\'col-xl-6\', \'col-lg-6\', \'col-md-12\', \'col-sm-12\', \'col-12\', {modal: showmodal}]" id="treeinfo" \n                                    style="padding-right:0px;">\n                                        <messagebody-container\n                                            v-bind:courseid="courseid" \n                                            v-bind:postdata="singlepostdata"\n                                            :identiconstring = "identiconstring"\n                                            :isused ="msgbodycontainerdisplay" \n                                            :isreading="isreading" \n                                            :isanswering="isanswering" \n                                            :iscreatingtopic="iscreatingtopic"\n                                            :viewportsize = "viewportsize"\n                                            :hideloadingicon = "hideloadingiconRMB"\n                                            v-on:answeredmsg="onansweredmsg"\n                                            v-on:prevmsg="onprevmsg" \n                                            v-on:nextmsg="onnextmsg"\n                                            v-on:closemodal="closemodal">\n                                        </messagebody-container>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <viz-bubble v-bind:treedata="treedata_viz" class="tab-pane fade" id="menu1"></viz-bubble>\n                    </div>\n                </div>\n            '})}}));