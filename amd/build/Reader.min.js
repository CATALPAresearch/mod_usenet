/**
 * Newsgroup reader
 * @module     mod/newsmod/Reader
 * @class      newsmod
 * @copyright  2020 Niels Seidel <niels.seidel@fernuni-hagen.de>
 * @license    MIT
 * @since      3.1
 */
define(["jquery",M.cfg.wwwroot+"/mod/newsmod/lib/build/vue.min.js",M.cfg.wwwroot+"/mod/newsmod/lib/build/axios.min.js",M.cfg.wwwroot+"/mod/newsmod/lib/build/identicon.min.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/ReaderMessageBody.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/ReaderPostContainer.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/VizBubble.js"],(function(t,i,s,e,n,o,a){return function(r,d,l){var c=new i({el:"newsmod-container",data:function(){return{message:"",searchstring:"",searchresult:[],hiddenposts:[],filter_assessment:!0,filter_text:!0,content:[],info:"Hallo, ich warte auf Daten vom usenet Server ...",tree_json:"",tree_data:"",treedata:{},tree_built:0,sequence:1,iterations:0,arraypos:0,post_list:[],singlepostdata:[],msgbodycontainerdisplay:"none",isreading:!1,isanswering:!1,iscreatingtopic:!1,markedpost:-1,courseid:d,hideloadingicon:!0,identiconstring:""}},components:{"messagebody-container":n,"post-container":o,"viz-bubble":a},created:function(){this.singlepostdata.header={name:"",subject:""},r.add("hello_world",{level:"fun",target:"vue is in place"}),t(".nav-link-h4").click((function(){r.add("toc_entry_open",{level:"h4",target:t(this).attr("href")})})),t(".nav-link-h3").click((function(){r.add("toc_entry_open",{level:"h3",target:t(this).attr("href")})}))},mounted:function(){let t=this;s.get(M.cfg.wwwroot+"/mod/newsmod/phpconn5.php?id="+d).then((function(i){return t.treedata=i.data.children,t.info=i,t.tree_data=i.data,t.buildtree(i.data,1),t.hideloadingicon=!0,1}))},computed:{},methods:{getMessageTree:function(){return this.tree_data.children},findinarr:function(t,i){for(let s=0;s<i.length;s++)if(i[s].messageid===t)return i[s]},ondisplaymsg:function(t){s.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+d+"&msgnr="+t).then(t=>(this.singlepostdata=t.data,this.identiconstring=this.getidenticon(this.singlepostdata.header.from+this.singlepostdata.header.name))),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1;let i=this.findinarr(t,this.post_list).arraypos;this.markedpost=i},onprevmsg:function(t){let e=this.findinarr(t,this.post_list).arraypos;e-=1,this.markedpost=e,t=this.post_list[e].messageid;let n=this.findinarr(t,this.post_list);n.hidden=!1,i.set(this.post_list,e,n),console.log(e),console.log(t),s.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+d+"&msgnr="+t).then(t=>(this.singlepostdata=t.data,this.identiconstring=this.getidenticon(this.singlepostdata.header.from+this.singlepostdata.header.name))),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onnextmsg:function(t){let e=this.findinarr(t,this.post_list);console.log(e.arraypos);let n=e.arraypos;n+=1,this.markedpost=n,t=this.post_list[n].messageid;let o=this.findinarr(t,this.post_list);o.hidden=!1,i.set(this.post_list,n,o),console.log(n),console.log(t),s.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+d+"&msgnr="+t).then(t=>(this.singlepostdata=t.data,this.identiconstring=this.getidenticon(this.singlepostdata.header.from+this.singlepostdata.header.name))),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onansweredmsg:function(){this.hideloadingicon=!1,c.post_list.splice(0),this.arraypos=0,this.msgbodycontainerdisplay="none",this.isanswering=!1,this.iscreatingtopic=!1,this.isreading=!1,setTimeout((function(){s.get(M.cfg.wwwroot+"/mod/newsmod/phpconn5.php?id="+c.courseid).then(t=>(c.info=t,c.tree_data=t.data,c.buildtree(t.data,1))),c.hideloadingicon=!0}),2e3)},buildtree:function(t,i){t.children.forEach(t=>{var s,e="0"!=t.markedstatus,n="0"==t.messagestatus,o=!1;if(t.picturestatus>"0")t.personal,t.sender,M.cfg.wwwroot,t.user_id;else{var a={background:[255,255,255,255],margin:.05,size:20,format:"svg"};"'<div class=\"control col-sm-3 col-xl-4\" title=\"Name: ' + val.personal \n                            + '\r\nE-Mail-Adresse: ' + val.sender + '\">\n                            <img width=19 height=20 src=\"data:image/svg+xml;base64,' + data + '\"></div>'"}a={background:[255,255,255,255],margin:.05,size:20,format:"svg"};if(s=this.getidenticon(t.sender+t.personal),o=!!t.children,!t.children);var r=new Date(t.date);a={year:"numeric",month:"2-digit",day:"2-digit"};r=new Date(t.date).toLocaleDateString("de-DE",a)?new Date(t.date).toLocaleDateString("de-DE",a):"";var d,l=t.personal?t.personal:t.sender;t.children&&(d=this.getfamily(t));var h={marked:e,unread:n,markedhtml:e,picturestatus:t.picturestatus,personal:t.personal,sender:t.sender,user_id:t.user_id,margin:i,sequence:this.sequence++,messageid:t.messageid,date:t.date,subject:t.name,calctime:r,absender:l,haschild:o,arraypos:this.arraypos++,isSelected:!1,hidden:!1,family:d,identicon:s};this.post_list.push(h),t.children&&c.buildtree(t,i+15)})},getfamily:function(t){var i=[];if(t.children){var s=t.children.length;for(let e=0;e<s;e++)i.push(t.children[e].messageid),t.children[e].children&&i.push(c.getfamily(t.children[e]))}return i},newTopic:function(){this.msgbodycontainerdisplay="",this.iscreatingtopic=!0,this.isreading=!1,this.isanswering=!1},search:function(t){this.hideallposts(),this.hideloadingicon=!1,s.get(M.cfg.wwwroot+"/mod/newsmod/search.php?id="+d+"&searchparam="+this.searchstring).then(t=>this.displaysearchresult("",t.data)).catch(t=>console.log(t))},hideallposts:function(){for(let t=0;t<this.post_list.length;t++){let s=this.post_list[t];s.hidden=!0,i.set(this.post_list,t,s)}},showallposts:function(){for(let t=0;t<this.post_list.length;t++){let s=this.post_list[t];s.hidden=!1,i.set(this.post_list,t,s)}},displaysearchresult:function(t,s){this.hideallposts();for(let t=0;t<s.length;t++){this.hiddenposts.push(this.findinarr(s[t].messagenum,this.post_list));let e=this.hiddenposts[t];void 0!==e.hidden?(e.hidden=!1,i.set(this.post_list,e.arraypos,e)):console.log("err displaysearchresult")}this.hideloadingicon=!0},resetsearchstring:function(){this.searchstring="",this.hiddenposts.splice(0),this.showallposts()},refresh:function(){this.hideloadingicon=!1,this.isreading=!1,this.isanswering=!1,this.msgbodycontainerdisplay="none",this.markedpost=-1,this.arraypos=0,this.post_list.splice(0),s.get(M.cfg.wwwroot+"/mod/newsmod/phpconn5.php?id="+d).then((function(t){return c.treedata=t.data.children,c.info=t,c.tree_data=t.data,c.buildtree(t.data,1),c.hideloadingicon=!0,1}))},getidenticon:function(t){var i=this.hash64(t,!0);return"data:image/svg+xml;base64,"+new e(i,{background:[255,255,255,255],margin:.05,size:20,format:"svg"}).toString()},hash32:function(t,i,s){var e,n,o=void 0===s?2166136261:s;for(e=0,n=t.length;e<n;e++)o^=t.charCodeAt(e),o+=(o<<1)+(o<<4)+(o<<7)+(o<<8)+(o<<24);return i?("0000000"+(o>>>0).toString(16)).substr(-8):o>>>0},hash64:function(t,i){var s=this.hash32(t,i);return s+this.hash32(s+t,i)}},template:'\n                <div id="newsmod-container">\n                    \n                    <div class="row control-bar">\n                        <div class="form-inline">\n                            <button class="btn btn-outline-primary btn-sm" v-on:click="newTopic" title="Ein neues Thema erstellen">\n                                <i class="fa fa-pen"></i>\n                                Neues Thema\n                            </button>\n\n                            <button class="btn btn-light btn-sm" v-on:click="refresh" title="Neue Nachrichten abholen">\n                                    <i class="fa fa-sync"></i>\n                            </button>\n                            <div class="search">\n                                <input class="form-control form-control-sm" v-model="searchstring" placeholder="Suchen..." v-on:click="resetsearchstring">\n\n                                <button class="btn btn-light btn-sm" type="submit" v-on:click="search" title="In allen Nachrichten suchen">\n                                    Suchen\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class="container-fluid px-0 ">\n                        <div class="px-0">\n                            <hr />\n                            <div class="row" >\n                                <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-12" id="tree" style="overflow:scroll; height:500px; margin-bottom:3px" >\n                                    <post-container \n                                        v-bind:courseid="courseid" \n                                        v-bind:postlist="post_list" \n                                        v-bind:markedpost="markedpost" \n                                        :showloadingicon="hideloadingicon" \n                                        v-on:displaymsg="ondisplaymsg">\n                                    </post-container>\n                                </div>\n                                <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-12 row-no-padding" id="treeinfo" style="padding-right:0px; height:500px">\n                                    <messagebody-container \n                                        v-bind:courseid="courseid" \n                                        v-bind:postdata="singlepostdata"\n                                        :identiconstring = "identiconstring"\n                                        :isused ="msgbodycontainerdisplay" \n                                        :isreading="isreading" \n                                        :isanswering="isanswering" \n                                        :iscreatingtopic="iscreatingtopic" \n                                        v-on:answeredmsg="onansweredmsg"\n                                        v-on:prevmsg="onprevmsg" \n                                        v-on:nextmsg="onnextmsg">\n                                    </messagebody-container>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <viz-bubble v-bind:treedata="treedata"></viz-bubble>\n                </div>\n            '})}}));