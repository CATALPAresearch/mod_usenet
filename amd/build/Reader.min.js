/**
 * Newsgroup reader
 * @module     mod/newsmod/Reader
 * @package    mod_newsmod
 * @class      newsmod
 * @copyright  2020 Niels Seidel, niels.seidel@fernuni-hagen.de
 * @license    MIT
 * @since      3.1
 */
define(["jquery"],(function(t){return function(e,s,n,i,a,o,r){e.component("post",{props:["content"],data:function(){return{isSelected:!1}},methods:{togglemarked:function(){n.get(M.cfg.wwwroot+"/mod/newsmod/statuschange.php?id="+o+"&msgnr="+this.content.messageid).then(),this.content.marked?this.content.marked=!1:this.content.marked=!0}},template:'\n                <div class = "post" :class="{hidden: this.content.hidden}">\n                    <li class="node px-0" :column="content.margin" :sequence="content.sequence" :marked="content.marked"\n                    :messageid="content.messageid" :data-date="new Date(content.date)" :class = "{\'font-weight-bold\': content.unread}">\n                        <div class ="container-fluid px-0">\n                            <div class = "row px-0" v-bind:class="{\'bg-info\': content.isSelected}">\n                                \n                                \n                                <div class = "px-0 col-sm-2 col-md-2 col-lg-2 col-xl-2" v-on:click="togglemarked">\n\n                                    \x3c!-- TODO insert jdenticon --\x3e\n\n                                    <template v-if="content.marked">\n                                    <i class="fas starmarked fa-star" />\n                                    </template>\n                                    <template v-else>\n                                    <i class="far fa-star" />\n                                    </template>\n\n                                    <template v-if="content.haschild">\n                                    <i class="fas fa-xs fa-arrow-down" />\n                                    </template>\n                                    <template v-else>\n                                    </template>\n                                </div>\n\n\n                                <div class = "col-sm-5 col-md-5 col-lg-5 col-xl-5" :style="{\'text-indent\': content.margin + \'px\'}" v-on:click="$emit(\'getmsg\', content.messageid, content.arraypos)">\n                                    {{content.subject}}\n                                </div>\n\n                                <div class = "col-sm-3 col-md-3 col-lg-3 col-xl-3">\n                                    {{content.personal}}\n                                </div>\n\n                                <div class="datetime message col-sm-2 col-md-2 col-lg-2 col-xl-2" data-date-format="DD.MM.YYYY">\n                                    {{content.calctime}}\n                                </div>\n                            </div>\n                        </div>\n                    </li>\n                </div>\n                '}),e.component("post-container",{props:["postlist","markedpost"],data:function(){return{previouspost:-1}},watch:{markedpost:function(){var t=this.postlist[this.markedpost];t.isSelected=!0,t.unread=!1,e.set(this.postlist,this.markedpost,t),-1!=this.previouspost&&this.previouspost!=this.markedpost&&((t=this.postlist[this.previouspost]).isSelected=!1,e.set(this.postlist,this.previouspost,t)),this.previouspost=this.markedpost}},methods:{ongetmsg:function(t,s){this.$emit("displaymsg",t);var n=this.postlist[s];n.isSelected=!0,n.unread=!1,e.set(this.postlist,s,n),-1!=this.previouspost&&this.previouspost!=s&&((n=this.postlist[this.previouspost]).isSelected=!1,e.set(this.postlist,this.previouspost,n)),this.previouspost=s}},template:'\n                    <div class ="post-container">\n                        <post    \n                        v-for="singlepost in postlist"\n                        v-bind:content="singlepost"\n                        v-bind:key = "singlepost.messageid"\n                        v-on:getmsg="ongetmsg">\n                        \n                        </post>\n                    </div>\n                '}),e.component("messagebody-container",{props:["postdata","isused","isreading","isanswering","iscreatingtopic"],data:function(){return{answerbuttontext:"Antworten",textareacontent:"",value:"",usrinput_subject:"",textarea_usrinput:""}},methods:{onanswerbuttonclick:function(){if(this.answerbuttontext="Antworten"==this.answerbuttontext?"Senden":"Antworten",this.isreading){this.isreading=!1,this.isanswering=!0;for(var t=this.textareacontent.split("\n"),e="\n",s=0;s<t.length;s++)e=e+">"+t[s]+"\n";this.textarea_usrinput=e}else{this.isreading=!0,this.isanswering=!1;const t=new URLSearchParams;t.append("userInput",this.textarea_usrinput),t.append("subject",this.postdata.header.subject),t.append("references",this.postdata.header.references),t.append("uid",this.postdata.header.id),n.post(M.cfg.wwwroot+"/mod/newsmod/posttest.php?id="+o+"&msgnr="+this.postdata.header.id,t).then(t=>this.value=t),this.$emit("answeredmsg")}},prevmsg:function(){this.$emit("prevmsg",this.postdata.header.number)},nextmsg:function(){this.$emit("nextmsg",this.postdata.header.number)},createtopic:function(){const t=new URLSearchParams;t.append("userInput",this.textareacontent),t.append("subject",this.usrinput_subject),n.post(M.cfg.wwwroot+"/mod/newsmod/posttest.php?id="+o+"&msgnr=new",t).then(t=>this.value=t),this.$emit("answeredmsg")}},watch:{postdata:function(){this.textareacontent=this.postdata.messagebody,this.isreading=!0,this.isanswering=!1,this.answerbuttontext="Antworten"},iscreatingtopic:function(){this.iscreatingtopic&&(this.textarea_usrinput="")}},template:'\n                <div class = "messagebody-container" :style = "{display: isused}">\n                    <div class="row-no-padding" style="padding-right:0px">\n                        <div class="col-xl">\n                            <template v-if = "iscreatingtopic">\n                                <button :class="\'btn btn-primary\'" v-on:click="createtopic">\n                                    Senden\n                                </button>\n                                <BR></BR>\n                                <label>\n                                    Betreff:\n                                </label>\n                                <textarea v-model="usrinput_subject" :class="{\'form-control\': true}" cols=30 rows=1> </textarea>\n                                <label>\n                                    Text:\n                                </label>\n                                <BR></BR>\n                                <textarea v-model="textarea_usrinput" :class="{\'form-control\': true, hidden: isreading}" cols=90 rows=17> </textarea>                        \n                            </template>\n                            <template v-else>\n                                <div>{{postdata.header.name}}\n                                </div>\n                                <div>{{postdata.header.subject}}\n                                </div>\n                            </template>\n                        </div>\n                    </div>\n\n                    <template v-if = "iscreatingtopic">\n                    </template>\n\n                    <template v-else>\n                    \n\n                        <div class="row">\n                            <button :class="\'btn btn-primary\'" v-on:click="onanswerbuttonclick">\n                                {{answerbuttontext}}\n                            </button>\n                            <button :class="\'btn btn-primary\'" v-on:click="prevmsg">\n                                Vorherige Nachricht\n                            </button>\n                            <button :class="\'btn btn-primary\'" v-on:click="nextmsg">\n                                NÃ¤chste Nachricht\n                            </button>\n                        </div>\n                        <template v-if="isreading">\n                            <div :class="\'row-no-padding\'" :style="{\'overflow-y\': \'scroll\', height: \'335.9px\'}">\n                                <div>\n                                    \x3c!-- \'white-space\': \'pre-line\' is needed here because v-model automatically formats nl it seems --\x3e\n                                    <span :style="{\'white-space\': \'pre-line\'}"> {{textareacontent}}</span>\n                                </div>\n                            </div>\n                        </template>\n                        <template v-else>\n                            <div :class="\'form-group\'" :style="{\'overflow-y\': \'scroll\', height: \'335.9px\'}">\n                                <textarea v-model="textarea_usrinput" :class="{\'form-control\': true, hidden: isreading}" cols=90 rows=17> </textarea>\n                            </div>\n                        </template>\n                    </template>                        \n                </div>\n            '});var d=new e({el:"newsmod-container",data:function(){return{message:"",searchstring:"",searchresult:[],hiddenposts:[],filter_assessment:!0,filter_text:!0,content:[],info:"Hallo, ich warte auf Daten vom usenet Server ...",tree_json:"",tree_data:"",tree_built:0,sequence:1,iterations:0,arraypos:0,post_list:[],singlepostdata:[],msgbodycontainerdisplay:"none",isreading:!1,isanswering:!1,iscreatingtopic:!1,markedpost:-1}},components:{},created:function(){a.add("hello_world",{level:"fun",target:"vue is in place"}),t(".nav-link-h4").click((function(){a.add("toc_entry_open",{level:"h4",target:t(this).attr("href")})})),t(".nav-link-h3").click((function(){a.add("toc_entry_open",{level:"h3",target:t(this).attr("href")})}))},mounted:function(){n.get(M.cfg.wwwroot+"/mod/newsmod/phpconn5.php?id="+o).then(t=>(this.info=t,this.tree_data=t.data,this.buildtree(t.data,1)))},computed:{},methods:{findinarr:function(t,e){for(let s=0;s<e.length;s++)if(e[s].messageid===t)return e[s]},ondisplaymsg:function(t){n.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+o+"&msgnr="+t).then(t=>(this.singlepostdata=t.data,this.iterations=999)),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1;let e=this.findinarr(t,this.post_list).arraypos;this.markedpost=e},onprevmsg:function(t){let e=this.findinarr(t,this.post_list).arraypos;e-=1,this.markedpost=e,t=this.post_list[e].messageid,console.log(e),console.log(t),n.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+o+"&msgnr="+t).then(t=>(this.singlepostdata=t.data,this.iterations=999)),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onnextmsg:function(t){let e=this.findinarr(t,this.post_list).arraypos;e+=1,this.markedpost=e,t=this.post_list[e].messageid,console.log(e),console.log(t),n.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+o+"&msgnr="+t).then(t=>(this.singlepostdata=t.data,this.iterations=999)),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onansweredmsg:function(){d.post_list.splice(0),this.arraypos=0,this.msgbodycontainerdisplay="none",this.isanswering=!1,this.iscreatingtopic=!1,this.isreading=!1,n.get(M.cfg.wwwroot+"/mod/newsmod/phpconn5.php?id="+o).then(t=>(this.info=t,this.tree_data=t.data,this.buildtree(t.data,1)))},buildtree:function(t,e){t.children.forEach(t=>{var s="0"!=t.markedstatus,n="0"==t.messagestatus,i=!1;if(t.picturestatus>"0")t.personal,t.sender,M.cfg.wwwroot,t.user_id;else{var a={background:[255,255,255,255],margin:.05,size:20,format:"svg"};"'<div class=\"control col-sm-3 col-xl-4\" title=\"Name: ' + val.personal \n                            + '\r\nE-Mail-Adresse: ' + val.sender + '\">\n                            <img width=19 height=20 src=\"data:image/svg+xml;base64,' + data + '\"></div>'"}if(i=!!t.children,!t.children);var o=new Date(t.date);a={year:"numeric",month:"2-digit",day:"2-digit"};o=new Date(t.date).toLocaleDateString("de-DE",a)?new Date(t.date).toLocaleDateString("de-DE",a):"";var r=t.personal?t.personal:t.sender,c={marked:s,unread:n,markedhtml:s,picturestatus:t.picturestatus,personal:t.personal,sender:t.sender,user_id:t.user_id,margin:e,sequence:this.sequence++,messageid:t.messageid,date:t.date,subject:t.name,calctime:o,absender:r,haschild:i,arraypos:this.arraypos++,isSelected:!1,hidden:!1};this.post_list.push(c),t.children&&d.buildtree(t,e+25)})},newTopic:function(){this.msgbodycontainerdisplay="",this.iscreatingtopic=!0,this.isreading=!1,this.isanswering=!1},search:function(t){n.get(M.cfg.wwwroot+"/mod/newsmod/search.php?id="+o+"&searchparam="+this.searchstring).then(t=>this.displaysearchresult("",t.data))},displaysearchresult:function(t,s){for(let t=0;t<this.post_list.length;t++){let s=this.post_list[t];s.hidden=!0,e.set(this.post_list,t,s)}for(let t=0;t<s.length;t++){this.hiddenposts.push(this.findinarr(s[t].number,this.post_list));let n=this.hiddenposts[t];n.hidden=!1,e.set(this.post_list,n.arraypos,n)}},resetsearchstring:function(){this.searchstring="",this.hiddenposts.splice(0);for(let t=0;t<this.post_list.length;t++){let s=this.post_list[t];s.hidden=!1,e.set(this.post_list,t,s)}}},template:'\n                <div id="newsmod-container">\n                    <div class="container-fluid">\n                        <div class="row">\n                            <div class="col-12">\n                                <div class="form-inline float-sm-left">\n                                    <button :class="\'btn btn-default\'" v-on:click="newTopic">\n                                        Neues Thema\n                                    </button>\n\n                                    <button :class="\'btn btn-default fa fa-sync\'" v-on:click="">\n                                         \n                                    </button>\n\n                                    <input v-model="searchstring" placeholder="Suchen..." v-on:click="resetsearchstring">\n\n                                    <button :class="\'btn btn-outline-success\'" type="submit" v-on:click="search">\n                                        Suchen\n                                    </button>\n                                </div>\n                                <div class="text-danger" id="orr">Bitte drehen Sie Ihr GerÃ¤t!</div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="container-fluid px-0 ">\n                        <div class="px-0">\n                            <hr />\n                            <div class="col-12 row" >\n                                \n                                <div class="col-xl-6 col-sm-10" id="tree" style="overflow:scroll; height:500px; margin-bottom:3px" >\n                                <post-container v-bind:postlist="post_list" v-bind:markedpost="markedpost"  v-on:displaymsg="ondisplaymsg"></post-container>\n                                \n                                </div>\n                                <div class="col-xl-6 col-sm-10 row-no-padding" id="treeinfo" style="padding-right:0px; height:500px">\n                                    <messagebody-container v-bind:postdata = "singlepostdata" :isused ="msgbodycontainerdisplay" \n                                    :isreading = "isreading" :isanswering = "isanswering" :iscreatingtopic = "iscreatingtopic" v-on:answeredmsg="onansweredmsg"\n                                    v-on:prevmsg="onprevmsg" v-on:nextmsg="onnextmsg">\n                                    \n                                    </messagebody-container>\n                                    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            '})}}));