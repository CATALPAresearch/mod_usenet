/**
 *
 *
 * @module     mod_usenet
 * @class      Post Container
 * @copyright  Niels Seidel <niels.seidel@fernuni-hagen.de>, Konstantin Friedrich
 * @license    GNU GPLv3
 * 
 * TODO:
 * - modularize code 
 * - remove redundancies like axios
 * - remove states 
 */
define([M.cfg.wwwroot+"/mod/usenet/lib/build/vue.min.js",M.cfg.wwwroot+"/mod/usenet/lib/build/axios.min.js",M.cfg.wwwroot+"/mod/usenet/lib/build/identicon.min.js",M.cfg.wwwroot+"/mod/usenet/amd/src/ReaderMessageBody.js",M.cfg.wwwroot+"/mod/usenet/amd/src/ReaderPostContainer.js",M.cfg.wwwroot+"/mod/usenet/amd/src/VizBubble.js"],(function(e,s,t,i,n,a){return function(o,r,l,d){var c=new e({el:"usenet-container",data:function(){return{instanceName:"Newsgroup",showMessageBody:!1,searchstring:"",searchresult:[],hiddenposts:[],filter_assessment:!0,filter_text:!0,content:[],tree_data:"",treedata_viz:{},sequence:0,arraypos:0,post_list:[],post_list_sections:[],post_list_section_size:50,post_list_section_reservespace:10,view_section:0,singlepostdata:[],threadlist:[],msgbodycontainerdisplay:"none",isreading:!1,isanswering:!1,iscreatingtopic:!1,markedpost:-1,courseid:r,hideloadingicon:!0,hideloadingiconRMB:!0,identiconstring:"",showmodal:!1,displayerrormsg:!1,newsgroup_name:"",newsgroup_postquantity:0,fetch_postquantity:50,start:"0",end:"0",errorMessages:[],searchresultmsg:"",statesearchresult:!1,statesRMB:{CanSelectNext:!0,CanSelectPrev:!0},statesview_section:{CanSelectNext:!0,CanSelectPrev:!1}}},components:{"messagebody-container":i,"post-container":n,"viz-bubble":a},created:function(){this.instanceName=d,this.singlepostdata.header={name:"",subject:""}},mounted:function(){this.initiatecontact()},methods:{logger(e,s){o.add(e,s)},hideMessageBody:function(){this.showMessageBody=!1},initiatecontact:function(){this.hideloadingicon=!1,this.getgroupinfo().then((function(e){s.get(M.cfg.wwwroot+"/mod/usenet/php/fetchtree.php?id="+r+"&start="+c.start+"&end="+c.end).then((function(e){c.check_for_error(e.data)?c.errorMessages.push(e.data):(c.treedata_viz=e.data.children,c.info=e,c.tree_data=e.data,c.gettree(e.data))})).catch((function(e){console.error(e)})).then((function(){c.hideloadingicon=!0}))}))},getgroupinfo:function(){return s.get(M.cfg.wwwroot+"/mod/usenet/php/groupinfo.php?id="+r).then((function(e){c.check_for_error(e.data)?c.errorMessages.push(e.data):c.processgroupinfo(e.data)})).catch((function(e){console.error(e)}))},processgroupinfo:function(e){c.newsgroup_name=e.groupname,c.newsgroup_postquantity=e.lastarticle-e.firstarticle+1,c.start=parseInt(e.firstarticle),c.end=parseInt(e.lastarticle)},getMessageTree:function(){return this.tree_data.children},findinarr:function(e,s){for(let t=0;t<s.length;t++)if(s[t].messagenumber===e)return s[t]},ondisplaymsg:function(e){this.showMessageBody=!0,this.hideloadingiconRMB=!1,s.get(M.cfg.wwwroot+"/mod/usenet/php/messageid.php?id="+r+"&msgnr="+e).then((function(e){if(c.check_for_error(e.data))c.errorMessages.push(e.data);else{if(c.singlepostdata=e.data,void 0===c.singlepostdata.header)return;c.singlepostdata.header.from&&c.singlepostdata.header.name&&(c.identiconstring=c.getidenticon(c.singlepostdata.header.from+c.singlepostdata.header.name))}})).catch((function(e){console.error(e)})).then((function(){c.hideloadingiconRMB=!0})),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1;let t=this.findinarr(e,this.post_list),i=this.post_list.indexOf(t);this.markedpost=i,this.stateupdateRMB()},setSelected:function(e){let s=this.findinarr(e,this.post_list);this.markedpost=this.post_list.indexOf(s)},onprevmsg:function(t){this.hideloadingiconRMB=!1;let i=this.findinarr(t,this.post_list),n=this.post_list.indexOf(i);n-=1,this.markedpost=n,t=this.post_list[n].messagenumber;let a=this.findinarr(t,this.post_list);a.hidden=!1,e.set(this.post_list,n,a),s.get(M.cfg.wwwroot+"/mod/usenet/php/messageid.php?id="+r+"&msgnr="+t).then((function(e){c.check_for_error(e.data)?c.errorMessages.push(e.data):(c.singlepostdata=e.data,c.singlepostdata.header.from&&c.singlepostdata.header.name&&(c.identiconstring=c.getidenticon(c.singlepostdata.header.from+c.singlepostdata.header.name)))})).catch((function(e){console.error(e)})).then((function(){c.hideloadingiconRMB=!0})),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1,this.stateupdateRMB()},onnextmsg:function(t){this.hideloadingiconRMB=!1;let i=this.findinarr(t,this.post_list),n=this.post_list.indexOf(i);n+=1,this.markedpost=n,t=this.post_list[n].messagenumber;let a=this.findinarr(t,this.post_list);a.hidden=!1,e.set(this.post_list,n,a),s.get(M.cfg.wwwroot+"/mod/usenet/php/messageid.php?id="+r+"&msgnr="+t).then((function(e){c.check_for_error(e.data)?c.errorMessages.push(e.data):(c.singlepostdata=e.data,c.identiconstring=c.getidenticon(c.singlepostdata.header.from+c.singlepostdata.header.name))})).catch((function(e){console.error(e)})).then((function(){c.hideloadingiconRMB=!0})),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1,this.stateupdateRMB()},displayPreviousPostlist:function(e){if(this.view_section>0){if(-1!=this.markedpost){this.post_list[this.markedpost].isSelected=!1}this.markedpost=-1,this.post_list=this.post_list_sections[--this.view_section],this.logger("messagelist_previous_click",{postlist_section:this.view_section}),this.isreading=!1,this.isanswering=!1,this.msgbodycontainerdisplay="none",this.arraypos=0,this.stateupdateview_selection()}e.preventDefault()},displayNextPostlist:function(e){if(this.view_section<this.post_list_sections.length-1){if(-1!=this.markedpost){this.post_list[this.markedpost].isSelected=!1}this.markedpost=-1,this.post_list=this.post_list_sections[++this.view_section],this.logger("messagelist_next_click",{postlist_section:this.view_section}),this.isreading=!1,this.isanswering=!1,this.msgbodycontainerdisplay="none",this.arraypos=0,this.stateupdateview_selection()}e.preventDefault()},selectPostlist:function(e,s){if(-1!=this.markedpost){this.post_list[this.markedpost].isSelected=!1}this.markedpost=-1,this.post_list=this.post_list_sections[e],this.logger("postlist_seclect_click",{postlist_section:e}),this.view_section=e,this.isreading=!1,this.isanswering=!1,this.msgbodycontainerdisplay="none",this.arraypos=0,this.stateupdateview_selection(),s.preventDefault()},stateupdateview_selection:function(){this.view_section<=0?e.set(this.statesview_section,"CanSelectPrev",!1):e.set(this.statesview_section,"CanSelectPrev",!0),this.view_section>=this.post_list_sections.length-1?e.set(this.statesview_section,"CanSelectNext",!1):e.set(this.statesview_section,"CanSelectNext",!0)},stateupdateRMB:function(){this.markedpost<=0?e.set(this.statesRMB,"CanSelectPrev",!1):e.set(this.statesRMB,"CanSelectPrev",!0),this.markedpost>=this.post_list_sections[this.view_section].length-1?e.set(this.statesRMB,"CanSelectNext",!1):e.set(this.statesRMB,"CanSelectNext",!0)},onansweredmsg:function(){this.hideloadingicon=!1,c.post_list.splice(0),this.post_list_sections.splice(0),this.threadlist.splice(0),this.arraypos=0,this.msgbodycontainerdisplay="none",this.isanswering=!1,this.iscreatingtopic=!1,this.isreading=!1;setTimeout((function(){c.refresh()}),2e3)},gettree:function(e){this.buildthread_starter(e,this.threadlist),this.buildsections(this.threadlist,this.post_list_sections,this.post_list_section_size,this.post_list_section_reservespace),this.post_list=this.post_list_sections[0]},buildsections:function(e,s,t,i){var n=t,a=i,o=0;s[o]=[];for(let r=0;r<e.length;r++)if(e[r].length>t){for(let t=0;t<e[r].length;t++)s[o].push(e[r][t]);s[++o]=[],n=t,a=i}else if(e[r].length>n&&(e[r].length>n+a?(s[++o]=[],n=t,a=i):(n=e[r].length,a=0)),e[r].length<=n){for(let t=0;t<e[r].length;t++)s[o].push(e[r][t]);n-=e[r].length}},buildthread_starter:function(e,s){void 0===e.children&&console.error("tree_data.children not defined",e),e.children.forEach(e=>{s.push(this.buildthread(e,1))})},buildthread:function(e,s,t=0){return 0==t&&(t=[]),t.push(this.prepare_postdata(e,s)),void 0!==e.children&&e.children.forEach(e=>{e.children?c.buildthread(e,s+15,t):t.push(this.prepare_postdata(e,s+15))}),t},buildtree_classic:function(e,s){void 0===e.children&&console.error("tree_data.children not defined",e),e.children.forEach(e=>{let t=this.prepare_postdata(e,s);this.post_list.push(t),e.children&&c.buildtree_classic(e,s+15)})},prepare_postdata:function(e,s=1){var t,i="0"!=e.markedstatus,n="0"==e.messagestatus,a=!1;if(e.picturestatus>"0")t=M.cfg.wwwroot+"/user/pix.php/"+e.user_id+"/f1.jpg";else{var o={background:[255,255,255,255],margin:.05,size:20,format:"svg"};t=this.getidenticon(e.sender+e.personal)}if(a=!!e.children,!e.children);var r=new Date(e.date);o={year:"numeric",month:"2-digit",day:"2-digit"};r=new Date(e.date).toLocaleDateString("de-DE",o)?new Date(e.date).toLocaleDateString("de-DE",o):"";var l=e.personal?e.personal:e.sender;let d;return e.children&&(d=this.getChildren(e)),{marked:i,unread:n,markedhtml:i,picturestatus:e.picturestatus,personal:e.personal,sender:e.sender,user_id:e.user_id,margin:s,sequence:this.sequence++,messageid:e.messageid,messagenumber:e.number,date:e.date,subject:e.name,calctime:r,absender:l,haschild:a,arraypos:this.arraypos++,isSelected:!1,hidden:!1,children:d,identicon:t}},getChildren:function(e){var s=[];if(e.children){var t=e.children.length;for(let i=0;i<t;i++)s.push(e.children[i].number),e.children[i].children&&s.push(c.getChildren(e.children[i]))}return s},newTopic:function(){this.msgbodycontainerdisplay="",this.showMessageBody=!0,this.iscreatingtopic=!0,this.isreading=!1,this.isanswering=!1,this.logger("new_message_click",{})},search:function(e){let t=this;this.hideallposts(),this.statesearchresult=!1,this.hideloadingicon=!1,this.logger("search_submit",{search_term:this.searchstring}),s.get(M.cfg.wwwroot+"/mod/usenet/php/search.php?id="+r+"&searchparam="+this.searchstring).then((function(e){c.check_for_error(e.data)?c.errorMessages.push(e.data):(c.displaysearchresult("",e.data),t.logger("search_result",{search_term:t.searchstring,result_length:e.data.length,results:e.data.map((function(e){return e.messagenum}))}),console.log("SEARCH",e.data))})).catch(e=>console.error(e)).then((function(){c.hideloadingicon=!0}))},hideallposts:function(){for(let s=0;s<this.post_list.length;s++){let t=this.post_list[s];t.hidden=!0,e.set(this.post_list,s,t)}},showallposts:function(){for(let s=0;s<this.post_list.length;s++){let t=this.post_list[s];t&&(t.hidden=!1,e.set(this.post_list,s,t))}this.statesearchresult=!1},hideSearchResults:function(){this.showallposts(),this.logger("search_results_close",{})},displaysearchresult:function(s,t){this.hideallposts(),this.hiddenposts=[],this.statesearchresult=!0,this.searchresultmsg=t.length;for(let s=0;s<t.length;s++){let i=this.findinarr(t[s].messagenum,this.post_list);void 0!==i?(i.hidden=!1,this.hiddenposts.push(i),e.set(this.post_list,i.arraypos,i)):console.error("error displaysearchresult")}},resetsearchstring:function(){this.searchstring="",this.hiddenposts.splice(0),this.displayerrormsg&&(this.post_list.pop(),this.arraypos--,this.displayerrormsg=!1),this.showallposts()},refresh:function(){this.logger("refresh_messages_click",{}),this.hideloadingicon=!1,this.statesearchresult=!1,this.isreading=!1,this.isanswering=!1,this.msgbodycontainerdisplay="none",this.markedpost=-1,this.arraypos=0,this.post_list.splice(0),this.post_list_sections.splice(0),this.threadlist.splice(0),this.initiatecontact()},getidenticon:function(e){var s=this.hash64(e,!0);return"data:image/svg+xml;base64,"+new t(s,{background:[255,255,255,0],margin:.05,size:20,format:"svg"}).toString()},hash32:function(e,s,t){var i,n,a=void 0===t?2166136261:t;for(i=0,n=e.length;i<n;i++)a^=e.charCodeAt(i),a+=(a<<1)+(a<<4)+(a<<7)+(a<<8)+(a<<24);return s?("0000000"+(a>>>0).toString(16)).substr(-8):a>>>0},hash64:function(e,s){var t=this.hash32(e,s);return t+this.hash32(t+e,s)},check_for_error:function(e){return void 0!==e.is_error},error_to_alert:function(e){c.errorMessages.push()}},template:'\n                <div id="usenet-container">\n                    <h3 class="mb-4"><img style="width:30px; height:30px;" src="pix/icon.svg"> {{ instanceName }}</h3>\n                    <div class="d-flex align-items-center">\n                        <button class="btn btn-primary btn-sm" :disabled="iscreatingtopic" v-on:click="newTopic" title="Eine neue Nachricht erstellen">\n                            <i class="fa fa-pen"></i>\n                            <span class="d-none d-sm-inline">Neue Nachricht</span>\n                        </button>\n\n                        <button class="btn btn-light btn-sm" v-on:click="refresh" title="Neue Nachrichten abholen">\n                            <i class="fa fa-sync"></i>\n                            <span class="d-none d-md-inline">aktualisieren</span>\n                        </button>\n\n                        <div class="mr-auto px-2">\n                            <div class="d-flex">\n                                <div>\n                                    <a class="page-link py-1 px-2" :class="{disabled: !statesview_section.CanSelectPrev}" v-on:click="displayPreviousPostlist($event)" \n                                        href="#" title="Vorherige Seite">\n                                        <i class="fa fa-chevron-left"></i>\n                                    </a>\n                                </div>\n                                <div class="d-none d-sm-block">\n                                    <a v-for="(el, index) in post_list_sections"\n                                        class="page-link py-1 px-2"\n                                        href="#"\n                                        v-on:click="selectPostlist(index, $event)"\n                                        :class="{\'bg-info\': view_section == index}"\n                                        >\n                                        {{index+1}}\n                                    </a>\n                                </div>\n                                <div>\n                                    <a class="page-link py-1 px-2" :class="{disabled: !statesview_section.CanSelectNext}" v-on:click="displayNextPostlist($event)" \n                                        href="#" title="NÃ¤chste Seite">\n                                        <i class="fa fa-chevron-right"></i>\n                                    </a>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class="search d-flex">\n                            <input \n                                class="form-control form-control-sm d-inline ml-2" \n                                v-model="searchstring" \n                                placeholder="Suchen..." \n                                v-on:keyup.enter="search"\n                                style="width:90px"\n                                >\n\n                            <button class="btn btn-light btn-sm" type="submit" v-on:click="search" title="In allen Nachrichten suchen">\n                                <i class="fa fa-search"></i>\n                            </button>\n                        </div>\n                        \n                    </div>\n\n                    \x3c!-- The tabs should shown if alternative visualization are available. --\x3e\n                    <ul class="nav nav-tabs mt-3">\n                        <li hidden class="nav-item pt-0">\n                            <a class="nav-link  pt-0 pb-0 active" v-on:click="logger(\'list_view_select\',{})" data-toggle="pill" href="#viewlist">\n                                <i class="fa fa-list"></i>\n                            </a>\n                        </li>\n                        <li hidden class="nav-item  pt-0">\n                            <a class="nav-link pt-0  pb-0"  v-on:click="logger(\'bubble_view_select\',{})" data-toggle="pill" href="#viewbubbles">\n                                <i class="fa fa-spinner"></i>\n                            </a>\n                        </li>\n                    </ul>\n\n                    <div class="tab-content">\n                        <div class="container-fluid px-2 border-left tab-pane active" id="viewlist">\n                            <div class="pt-4 pl-0">\n                                <div class="row" >\n                                \x3c!--\n                                    <div v-if="showMessageBody" class="d-block d-sm-none">\n                                        <messagebody-container \n                                            v-bind:courseid="courseid"\n                                            v-bind:postdata="singlepostdata"\n                                            :identiconstring = "identiconstring"\n                                            :isused ="msgbodycontainerdisplay" \n                                            :isreading="isreading" \n                                            :isanswering="isanswering" \n                                            :iscreatingtopic="iscreatingtopic"\n                                            :hideloadingicon = "hideloadingiconRMB"\n                                            v-on:answeredmsg="onansweredmsg"\n                                            v-on:prevmsg="onprevmsg" \n                                            v-on:nextmsg="onnextmsg"\n                                            v-on:hideMessageBody="hideMessageBody"\n                                            @log="logger"\n                                            >\n                                        </messagebody-container>\n                                    </div>\n                                --\x3e\n                                    <div class="col-xl-6 col-lg-6 col-md-12 col-sm-12 col-12 border-right" id="tree" style="overflow-y:auto; overflow-x:hidden; margin-bottom:3px; height: auto" >\n                                        <div v-for="error in errorMessages" class="alert alert-danger">\n                                            {{ error.errordescr }}\n                                            <button type="button" class="close" v-on:click="logger(\'error_alert_close\', { error_message: error.errordescr })" data-dismiss="alert" aria-label="Close">\n                                                <span aria-hidden="true">&times;</span>\n                                            </button>\n                                        </div>\n                                        <div v-if = "statesearchresult" class = "alert alert-success">\n                                            Ihre Suche hat {{ searchresultmsg }} Treffer erzielt\n                                            <button type="button" class="close" aria-label="Close" v-on:click="hideSearchResults()">\n                                                <span aria-hidden="true">&times;</span>\n                                            </button>\n                                        </div>\n                                        <post-container \n                                            v-bind:courseid="courseid" \n                                            v-bind:postlist="post_list" \n                                            v-bind:markedpost="markedpost" \n                                            :showloadingicon="hideloadingicon"\n                                            v-on:displaymsg="ondisplaymsg"\n                                            v-on:setSelected="setSelected"\n                                            @log="logger"\n                                            >\n                                        </post-container>\n                                    </div>\n                                    <div class="col-xl-6 col-lg-6 col-md-12 d-none d-sm-inline" id="treeinfo">\n                                        \x3c!-- , {modal: showmodal} :class="[\'col-xl-6\', \'col-lg-6\', \'col-md-12\', \'col-sm-12\', \'col-12\']"--\x3e\n                                        <messagebody-container \n                                            v-bind:courseid="courseid" \n                                            v-bind:postdata="singlepostdata"\n                                            :identiconstring = "identiconstring"\n                                            :isused ="msgbodycontainerdisplay" \n                                            :isreading="isreading" \n                                            :isanswering="isanswering" \n                                            :iscreatingtopic="iscreatingtopic"\n                                            :hideloadingicon = "hideloadingiconRMB"\n                                            :statesRMB = "statesRMB"\n                                            v-on:answeredmsg="onansweredmsg"\n                                            v-on:prevmsg="onprevmsg" \n                                            v-on:nextmsg="onnextmsg"\n                                            v-on:hideMessageBody="hideMessageBody"\n                                            @log="logger"\n                                            >\n                                        </messagebody-container>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <viz-bubble \n                            v-bind:treedata="treedata_viz" \n                            class="tab-pane fade" \n                            id="viewbubbles"\n                            @log="logger"\n                            ></viz-bubble>\n                    </div>\n                </div>\n            '})}}));