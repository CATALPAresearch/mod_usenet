/**
 * Newsgroup reader
 * @module     mod/newsmod/Reader
 * @class      newsmod
 * @copyright  2020 Niels Seidel <niels.seidel@fernuni-hagen.de>
 * @license    MIT
 * @since      3.1
 */
define(["jquery",M.cfg.wwwroot+"/mod/newsmod/lib/build/vue.min",M.cfg.wwwroot+"/mod/newsmod/lib/build/axios.min",M.cfg.wwwroot+"/mod/newsmod/amd/src/ReaderMessageBody.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/ReaderPostContainer.js",M.cfg.wwwroot+"/mod/newsmod/amd/src/VizBubble.js"],(function(s,t,e,i,n,a){return function(o,r,d){var l=new t({el:"newsmod-container",data:function(){return{message:"",searchstring:"",searchresult:[],hiddenposts:[],filter_assessment:!0,filter_text:!0,content:[],info:"Hallo, ich warte auf Daten vom usenet Server ...",tree_json:"",tree_data:"",tree_built:0,sequence:1,iterations:0,arraypos:0,post_list:[],singlepostdata:[],msgbodycontainerdisplay:"none",isreading:!1,isanswering:!1,iscreatingtopic:!1,markedpost:-1}},components:{"messagebody-container":i,"post-container":n,"viz-bubble":a},created:function(){o.add("hello_world",{level:"fun",target:"vue is in place"}),s(".nav-link-h4").click((function(){o.add("toc_entry_open",{level:"h4",target:s(this).attr("href")})})),s(".nav-link-h3").click((function(){o.add("toc_entry_open",{level:"h3",target:s(this).attr("href")})}))},mounted:function(){e.get(M.cfg.wwwroot+"/mod/newsmod/phpconn5.php?id="+r).then(s=>(this.info=s,this.tree_data=s.data,this.buildtree(s.data,1)))},computed:{},methods:{findinarr:function(s,t){for(let e=0;e<t.length;e++)if(t[e].messageid===s)return t[e]},ondisplaymsg:function(s){e.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+r+"&msgnr="+s).then(s=>(this.singlepostdata=s.data,this.iterations=999)),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1;let t=this.findinarr(s,this.post_list).arraypos;this.markedpost=t},onprevmsg:function(s){let t=this.findinarr(s,this.post_list).arraypos;t-=1,this.markedpost=t,s=this.post_list[t].messageid,console.log(t),console.log(s),e.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+r+"&msgnr="+s).then(s=>(this.singlepostdata=s.data,this.iterations=999)),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onnextmsg:function(s){let t=this.findinarr(s,this.post_list).arraypos;t+=1,this.markedpost=t,s=this.post_list[t].messageid,console.log(t),console.log(s),e.get(M.cfg.wwwroot+"/mod/newsmod/messageid.php?id="+r+"&msgnr="+s).then(s=>(this.singlepostdata=s.data,this.iterations=999)),this.msgbodycontainerdisplay="",this.iscreatingtopic=!1,this.isreading=!0,this.isanswering=!1},onansweredmsg:function(){l.post_list.splice(0),this.arraypos=0,this.msgbodycontainerdisplay="none",this.isanswering=!1,this.iscreatingtopic=!1,this.isreading=!1,e.get(M.cfg.wwwroot+"/mod/newsmod/phpconn5.php?id="+r).then(s=>(this.info=s,this.tree_data=s.data,this.buildtree(s.data,1)))},buildtree:function(s,t){s.children.forEach(s=>{var e="0"!=s.markedstatus,i="0"==s.messagestatus,n=!1;if(s.picturestatus>"0")s.personal,s.sender,M.cfg.wwwroot,s.user_id;else{var a={background:[255,255,255,255],margin:.05,size:20,format:"svg"};"'<div class=\"control col-sm-3 col-xl-4\" title=\"Name: ' + val.personal \n                            + '\r\nE-Mail-Adresse: ' + val.sender + '\">\n                            <img width=19 height=20 src=\"data:image/svg+xml;base64,' + data + '\"></div>'"}if(n=!!s.children,!s.children);var o=new Date(s.date);a={year:"numeric",month:"2-digit",day:"2-digit"};o=new Date(s.date).toLocaleDateString("de-DE",a)?new Date(s.date).toLocaleDateString("de-DE",a):"";var r=s.personal?s.personal:s.sender,d={marked:e,unread:i,markedhtml:e,picturestatus:s.picturestatus,personal:s.personal,sender:s.sender,user_id:s.user_id,margin:t,sequence:this.sequence++,messageid:s.messageid,date:s.date,subject:s.name,calctime:o,absender:r,haschild:n,arraypos:this.arraypos++,isSelected:!1,hidden:!1};this.post_list.push(d),s.children&&l.buildtree(s,t+25)})},newTopic:function(){this.msgbodycontainerdisplay="",this.iscreatingtopic=!0,this.isreading=!1,this.isanswering=!1},search:function(s){e.get(M.cfg.wwwroot+"/mod/newsmod/search.php?id="+r+"&searchparam="+this.searchstring).then(s=>this.displaysearchresult("",s.data))},displaysearchresult:function(s,e){for(let s=0;s<this.post_list.length;s++){let e=this.post_list[s];e.hidden=!0,t.set(this.post_list,s,e)}for(let s=0;s<e.length;s++){this.hiddenposts.push(this.findinarr(e[s].number,this.post_list));let i=this.hiddenposts[s];i.hidden=!1,t.set(this.post_list,i.arraypos,i)}},resetsearchstring:function(){this.searchstring="",this.hiddenposts.splice(0);for(let s=0;s<this.post_list.length;s++){let e=this.post_list[s];e.hidden=!1,t.set(this.post_list,s,e)}}},template:'\n                <div id="newsmod-container">\n                    <viz-bubble tree="tree_data"></viz-bubble>\n                    <div class="container-fluid">\n                        <div class="row">\n                            <div class="col-12">\n                                <div class="form-inline float-sm-left">\n                                    <button :class="\'btn btn-default\'" v-on:click="newTopic">\n                                        Neues Thema\n                                    </button>\n\n                                    <button :class="\'btn btn-default fa fa-sync\'" v-on:click="">\n                                         \n                                    </button>\n\n                                    <input v-model="searchstring" placeholder="Suchen..." v-on:click="resetsearchstring">\n\n                                    <button :class="\'btn btn-outline-success\'" type="submit" v-on:click="search">\n                                        Suchen\n                                    </button>\n                                </div>\n                                <div class="text-danger" id="orr">Bitte drehen Sie Ihr Ger√§t!</div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="container-fluid px-0 ">\n                        <div class="px-0">\n                            <hr />\n                            <div class="col-12 row" >\n                                \n                                <div class="col-xl-6 col-sm-10" id="tree" style="overflow:scroll; height:500px; margin-bottom:3px" >\n                                <post-container v-bind:postlist="post_list" v-bind:markedpost="markedpost"  v-on:displaymsg="ondisplaymsg"></post-container>\n                                \n                                </div>\n                                <div class="col-xl-6 col-sm-10 row-no-padding" id="treeinfo" style="padding-right:0px; height:500px">\n                                    <messagebody-container v-bind:postdata="singlepostdata" :isused ="msgbodycontainerdisplay" \n                                    :isreading = "isreading" :isanswering = "isanswering" :iscreatingtopic = "iscreatingtopic" v-on:answeredmsg="onansweredmsg"\n                                    v-on:prevmsg="onprevmsg" v-on:nextmsg="onnextmsg">\n                                    \n                                    </messagebody-container>\n                                    \n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    \n                </div>\n            '})}}));